### MSAA多重采样抗锯齿

顶点到片段过程中，首先是有三个顶点，每个像素的中心包含有一个采样点，在每一个采样点被遮住的像素处都会生成一个片段。由于屏幕像素总量的限制，有些边缘的像素能够被渲染出来，而有些则不会。因此导致了锯齿的出现。

![image-20250601122926079](C:\Users\SOF\Desktop\OpenGL笔记\assets\image-20250601122926079.png)

![image-20250601122933853](C:\Users\SOF\Desktop\OpenGL笔记\assets\image-20250601122933853.png)

MSAA将单一的采样点变为多个采样点，子采样点个数越多显然精度越高

![image-20250601123537356](C:\Users\SOF\Desktop\OpenGL笔记\assets\image-20250601123537356.png)

一种显而易见的方法是，对每个被遮盖住的子采样点运行一次片段着色器，最后将每个像素所有子采样点的颜色平均一下。然而实际上需要运行多次的片段着色器，会显著地降低性能。

无论三角形遮盖了多少个子采样点，（每个图元中）每个像素只运行**一次**片段着色器。片段着色器使用插值到像素**中心**的顶点数据，然后，MSAA使用更大的深度/模板缓冲区来确定子采样点的覆盖率。被覆盖的子采样点数量将决定了像素颜色对帧缓冲的影响程度。因为上图的4个采样点中只有2个被遮盖住了，所以三角形的颜色会有一半与帧缓冲区的颜色（在这里是无色）进行混合，最终形成一种淡蓝色。

![image-20250601125349199](C:\Users\SOF\Desktop\OpenGL笔记\assets\image-20250601125349199.png)

对深度测试来说，在运行深度测试之前，每个顶点的深度值会被插值到各个子样本中。

而对模板测试来说，我们会为每个子样本存储模板值，这意味着缓冲区的大小会根据每个像素的子采样点数量而相应增加。

### OpenGL的MSAA

4xMSAA

![image-20250602110132495](C:\Users\SOF\Desktop\OpenGL笔记\assets\image-20250602110132495.png)

显式开启

![image-20250602110206181](C:\Users\SOF\Desktop\OpenGL笔记\assets\image-20250602110206181.png)

### 离屏MSAA

首先是创建帧缓冲对象、添加附件等一系列操作：

颜色附件纹理这里要用专门的函数和参数

![image-20250602120446062](C:\Users\SOF\Desktop\OpenGL笔记\assets\image-20250602120446062.png)

渲染缓冲对象同理

![image-20250602120536119](C:\Users\SOF\Desktop\OpenGL笔记\assets\image-20250602120536119.png)

在帧缓冲中，只需要先画自定义的帧缓冲，再把它的颜色附件纹理拿出来画在其他物体上就可以了

但是多重采样缓冲有一点特别，我们不能直接将它们的缓冲图像用于其他运算，比如在着色器中对它们进行采样，因为一个多重采样的图像包含比普通图像更多的信息，我们所要做的是缩小或者还原(Resolve)图像

![image-20250602121556958](C:\Users\SOF\Desktop\OpenGL笔记\assets\image-20250602121556958.png)

`glBlitFramebuffer`会根据`GL_READ_FRAMEBUFFER`与`GL_DRAW_FRAMEBUFFER`，决定哪个是源帧缓冲，哪个是目标帧缓冲，然后将`GL_READ_FRAMEBUFFER`复制到`GL_DRAW_FRAMEBUFFER`，并且将多重采样缓冲还原。上述代码是直接将自定义帧缓冲的内容复制到屏幕的那个帧缓冲中了，就可以直接出结果：

![image-20250602121759121](C:\Users\SOF\Desktop\OpenGL笔记\assets\image-20250602121759121.png)

如果说还想再弄一个后处理（前面说了，多重采样缓冲的内容不能直接处理，必须经过还原或者缩小），可以依据同样的逻辑，把经过抗锯齿处理的数据传送到另一个普通的帧缓冲`intermediateFBO`中，然后再进行后处理

![image-20250602121919342](C:\Users\SOF\Desktop\OpenGL笔记\assets\image-20250602121919342.png)

